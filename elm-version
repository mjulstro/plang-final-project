import Html exposing (beginnerProgram, div, button, text)
import Html.Events exposing (onClick)
import List

main =
  beginnerProgram { model = model, view = view, update = update }
  
  
-- MODEL

type alias Model =
  { humans: List Villager
  , vampires: List Villager
  }
  
model = 
  { humans = []
  , vampires = []
  }
  
type alias Villager =
  { name : String
  , health : Int
  , strength : Int}



-- UPDATE

type Msg = AddHuman | AddVampire | Interact

update: Msg -> Model -> Model
update msg model =
  case msg of
    AddHuman ->
      let
        humanNames = ["Maggie", "Jack", "Jill", "Nathan", "Sam"]
      in
        { humans = List.append model.humans [{name = "Human", health = 5, strength = 2}]
        , vampires = model.vampires
        }

    AddVampire ->
      let
        vampireNames = ["Kanaya", "Victoire", "Horatio", "Everild", "Donovan"]
      in
        { humans = model.humans
        , vampires = List.append model.vampires [{name = "Vampire", health = 5, strength = 4}]
        }
      
    Interact ->
      model
        |> feedTheVampires
        |> healTheHumans
        --|> huntTheVampires
      
      
-- VIEW

view model =
  div []
    [ button [ onClick AddHuman ] [ text "Add Human" ]
    , button [ onClick AddVampire ] [ text "Add Vampire" ]
    , button [ onClick Interact ] [ text "A Day Goes By" ]
    , div [] [ text (showModel model)]
    ]
    
-- showModel: Model -> String --NOTE: this type annotation doesn't work even though the function does
showModel model = 
  list model.vampires
    |> String.append (list model.humans)
    |> String.append "Your town contains: \n"
    {- NOTE: When I need to add in things like "Somebody died!" how do I do that?
    Maybe add a variable to the model and append the extra messages only if the
    variable is true? -}

list: List Villager -> String
list villagerList =
  case villagerList of
    [] -> ""
    [head] ->
      (toString head.strength)
        |> String.append ", Strength = "
        |> String.append (toString head.health)
        |> String.append ": Health = "
        |> String.append head.name
        |> String.append "\n"
        -- NOTE: how do I get the newline character to work?
    (head::tail) ->
      String.append (list [head]) (list tail)



-- FUNCTIONS


population model =
  (List.length model.vampires) + (List.length model.humans)


feedTheVampires: Model -> Model
feedTheVampires model =
  let
    numVamps = List.length model.vampires
    numHums = List.length model.humans
  in

  if (numVamps > numHums) then
    let
    in
    { humans = damageSlowly model.humans numVamps
    , vampires = heal model.vampires 1
    }

  else if (numHums > numVamps) then
    let
      bittenHumans = List.take numVamps model.humans
      safeHumans = List.drop numVamps model.humans
    in
    { humans = List.concat [safeHumans, (damage bittenHumans 1)]
    , vampires = heal model.vampires 1
    }

  else
    { humans = damage model.humans 1
    , vampires = heal model.vampires 1
    }


damageSlowly: List Villager -> Int -> List Villager
damageSlowly villagers num =
  let
    firstDamage = num // (List.length villagers)
    midFight = damage villagers firstDamage
    leftover = num % (List.length villagers)
    moreHurt = List.take leftover midFight
  in
  List.concat [(List.drop leftover midFight), (damage moreHurt 1)]


healTheHumans: Model -> Model
healTheHumans thisModel =
  { humans = heal thisModel.humans 1
  , vampires = thisModel.vampires
  }

heal: List Villager -> Int -> List Villager
heal humans num = 
  case humans of
    [] ->
      []
    [head] ->
      [{name = head.name
       , health = head.health + num
       , strength = head.strength
       }]
    (head::tail) ->
      List.append (heal [head] num) (heal tail num)


--huntTheVampires: Model -> Model
--huntTheVampires thisModel =
--  if thisModel.aHumanIsDying then
--    let
--      thisVampire =
--        case get thisModel.vampireIndex thisModel.vampires of
--          Just vamp ->
--            vamp
--          Nothing ->
--            { name = "Tried to fight a nonexistent vampire"
--            , health = 0
--            , strength = 0
--            }
--      beforeVamps = List.take (thisModel.vampireIndex - 1) thisModel.vampires
--      afterVamps = List.drop thisModel.vampireIndex thisModel.vampires
--    in

sumStrength: List Villager -> Int
sumStrength villagers =
  case villagers of
    [] -> 0
    [head] -> head.strength
    (head::tail) ->
      (head.strength + (sumStrength tail))
      -- NOTE: gives me a syntax error and idk why

damage: List Villager -> Int -> List Villager
damage villagers strengthDiff =
  case villagers of
    [] -> []
    [head] ->
      let
        newHealth = head.health - strengthDiff
      in
        if (newHealth <= 0) then
          []
        else
          [{ name = head.name
           , health = newHealth
           , strength = head.strength
           }]
    (head::tail) ->
      List.append (damage [head] strengthDiff) (damage tail strengthDiff)

get: Int -> List a -> Maybe a
get n xs =
  List.head (List.drop n xs)
